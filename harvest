#!/bin/bash

#
# GLOBAL VARIABLES
#

HOSTNAME="https://api.harvestapp.com/v2"

BASE_DIRECTORY=$(dirname "$0")

CREDENTIALS_FILE="$BASE_DIRECTORY/.credentials/harvest.json"
PROJECT_CACHE_FILE="$BASE_DIRECTORY/.cache/harvest-projects.json"
TASK_CACHE_FILE="$BASE_DIRECTORY/.cache/harvest-tasks.json"
CURRENT_PROJECT_FILE="$BASE_DIRECTORY/.current-project"
CURRENT_TASK_FILE="$BASE_DIRECTORY/.current-task"

ACCESS_TOKEN=""
ACCOUNT_ID=""

#
# FUNCTIONS
#

function load_credentials() {
    CREDENTIALS_JSON=$(cat "$CREDENTIALS_FILE")

    ACCESS_TOKEN=$(echo "$CREDENTIALS_JSON" | jq -r '.access_token')

    ACCOUNT_ID=$(echo "$CREDENTIALS_JSON" | jq -r '.account_id')
}

function get() {
    curl --no-progress-meter "$1" \
      -H "Authorization: Bearer $ACCESS_TOKEN" \
      -H "Harvest-Account-Id: $ACCOUNT_ID" \
      -H "User-Agent: Test App (therealsebshady@googlemail.com)"
}

function post() {
    curl --no-progress-meter "$1" \
      -H "Authorization: Bearer $ACCESS_TOKEN" \
      -H "Harvest-Account-Id: $ACCOUNT_ID" \
      -H "User-Agent: Test App (therealsebshady@googlemail.com)" \
      -X POST \
      -H "Content-Type: application/json" \
      -d "$2"
}

function start_timing() {
    CURRENT_PROJECT=$(cat $CURRENT_PROJECT_FILE)
    CURRENT_TASK=$(cat $CURRENT_TASK_FILE)
    DATE=$(date +%F)

    DATA=$(cat \
<<JSON
    "project_id": $CURRENT_PROJECT,
    "task_id": $CURRENT_TASK,
    "spent_date": "$DATE",
    "notes":"$1"
JSON
    )

    if [[ ! -z $2 ]]; then
        DATA=$(cat \
<<JSON
    $DATA,
    "external_reference": {
        "permalink": "$2"
    }
JSON
        )
    fi

    post "$HOSTNAME/time_entries" "{$DATA}"
}

function list_projects() {
    jq --raw-output '.projects[] | (.id | tostring) + " " + .name' "$PROJECT_CACHE_FILE"
}

function list_tasks() {
    jq --raw-output '.tasks[] | (.id | tostring) + " " + .name' "$TASK_CACHE_FILE"
}

function get_current_user() {
    get "$HOSTNAME/users/me"
}

function get_current_project() {
    if [[ -f "$CURRENT_PROJECT_FILE" ]]; then
        PROJECT_ID=$(cat "$CURRENT_PROJECT_FILE")

        jq --raw-output ".projects[] | select(.id == $PROJECT_ID) | (.id | tostring) + \" \" + .name" "$PROJECT_CACHE_FILE"
    fi
}

function set_current_project() {
    echo "$1" > "$CURRENT_PROJECT_FILE"
}

function get_current_task() {
    if [[ -f "$CURRENT_TASK_FILE" ]]; then
        TASK_ID=$(cat "$CURRENT_TASK_FILE")

        jq --raw-output ".tasks[] | select(.id == $TASK_ID) | (.id | tostring) + \" \" + .name" "$TASK_CACHE_FILE"
    fi
}

function set_current_task() {
    ORIGINAL_IFS=$IFS
    IFS=$'\n'

    TASKS=$(jq -r ".tasks[] | (.id | tostring) + \"    \" + .name" "$TASK_CACHE_FILE" | grep -i "$1" )

    select TASK in $TASKS
    do
        break
    done

    TASK=$(echo "$TASK" | cut -d " " -f 1)

    echo "$TASK" > "$CURRENT_TASK_FILE"
}

function clear_cache() {
    rm -f "$PROJECT_CACHE_FILE"
    rm -f "$TASK_CACHE_FILE"
}

#
# SCRIPT
#

if [[ $# -eq 0 ]]; then
    printf "Usage: %s COMMAND [OPTIONS].\n" $(basename "$0")
    echo ""
    echo "Available Commands:"
    echo ""
    echo "clear-cache, cc                       Clear cache"
    echo "list-projects, lp                     List available projects"
    echo "list-tasks, lt                        List available tasks"
    echo "get-current-project, gcp              Get the ID of the current project"
    echo "set-current-project, scp  PROJECT_ID  Set the current project"
    echo "get-current-task, gct                 Get the ID of the current task"
    echo "set-current-task, sct     TASK_ID     Set the current task"
    echo "start-timing, st          NOTES [URL] Start a new timer on the current project and current task with NOTES and optionally linked to [URL]" 
    exit 1
fi

load_credentials

if [[ ! -f $PROJECT_CACHE_FILE ]]; then
    get "$HOSTNAME/projects" > $PROJECT_CACHE_FILE
fi

if [[ ! -f $TASK_CACHE_FILE ]]; then
    get "$HOSTNAME/tasks" > $TASK_CACHE_FILE
fi

case $1 in
    "clear-cache" | "cc" )
        clear_cache
        ;;
    "list-projects" | "lp" )
        list_projects
        ;;
    "list-tasks" | "lt" )
        list_tasks
        ;;
    "get-current-project" | "gcp" )
        get_current_project
        ;;
    "set-current-project" | "scp" )
        set_current_project "$2"
        ;;
    "get-current-task" | "gct" )
        get_current_task
        ;;
    "set-current-task" | "sct" )
        set_current_task "$2"
        ;;
    "start-timing" | "st" )
        start_timing "$2" "$3"
        ;;
esac
